name: Auto Sync Homebrew Core

on:
  schedule:
    - cron: "0 * * * *"   # 每小时执行一次
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Check upstream latest commit
        id: check
        run: |
          LATEST=$(git ls-remote https://github.com/Homebrew/homebrew-core.git HEAD | awk '{print $1}')
          echo "latest_upstream=$LATEST" >> $GITHUB_OUTPUT

          if [ -f sync_version ]; then
            LAST=$(cat sync_version)
          else
            LAST="none"
          fi
          echo "last_synced=$LAST" >> $GITHUB_OUTPUT

      - name: Skip if no update
        if: ${{ steps.check.outputs.latest_upstream == steps.check.outputs.last_synced }}
        run: echo "No updates." && exit 0

      - name: Clone latest Homebrew core without history
        run: |
          rm -rf homebrew-core
          git clone --depth=1 https://github.com/Homebrew/homebrew-core.git

      - name: Move all except .github
        run: |
          shopt -s dotglob
          for f in homebrew-core/*; do
              [ "${f##*/}" = ".github" ] && continue
              mv "$f" .
          done
          shopt -u dotglob
          rm -rf homebrew-core
      - name: Move .github
        run: |
          git clone "https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git"
          mv homebrew-core-lite/.github .
          rm -rf homebrew-core-lite

      - name: Re-init git with single commit
        run: |
          rm -rf .git
          git init
          git add .
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Sync $(date +'%Y-%m-%d %H:%M:%S')"

      - name: Force push
        run: |
          git branch -M main
          git remote add origin "https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git"
          git push -f origin main
